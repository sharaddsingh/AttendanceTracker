<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Faculty Permissions</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Faculty Permissions Diagnostic & Fix Tool</h1>
        <p>This tool will diagnose and fix the "Missing or insufficient permissions" error for batch reports.</p>
        
        <div id="authStatus" class="step">
            <h3>Step 1: Check Authentication Status</h3>
            <p>Checking current user authentication...</p>
            <button onclick="checkAuth()">Check Auth</button>
        </div>

        <div id="facultyDocStatus" class="step">
            <h3>Step 2: Check Faculty Document</h3>
            <p>Checking if faculty document exists...</p>
            <button onclick="checkFacultyDoc()">Check Faculty Doc</button>
        </div>

        <div id="permissionTest" class="step">
            <h3>Step 3: Test Firestore Permissions</h3>
            <p>Testing access to required collections...</p>
            <button onclick="testPermissions()">Test Permissions</button>
        </div>

        <div id="fixSection" class="step" style="display: none;">
            <h3>Step 4: Fix Issues</h3>
            <p>Create missing faculty document...</p>
            <button onclick="createFacultyDoc()">Create Faculty Document</button>
        </div>

        <div id="logs" class="step">
            <h3>Diagnostic Logs</h3>
            <div id="logOutput" class="log">
                Logs will appear here...
            </div>
            <button onclick="clearLogs()">Clear Logs</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <script>
        let currentUser = null;
        let facultyProfile = null;

        function log(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#333';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logOutput').innerHTML = 'Logs cleared...';
        }

        function updateStepStatus(stepId, status, message) {
            const step = document.getElementById(stepId);
            step.className = `step ${status}`;
            const p = step.querySelector('p');
            p.innerHTML = message;
        }

        async function checkAuth() {
            log('Checking authentication status...');
            
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    log(`‚úÖ User authenticated: ${user.email} (UID: ${user.uid})`, 'success');
                    updateStepStatus('authStatus', 'success', `
                        <strong>‚úÖ Authentication Successful</strong><br>
                        Email: ${user.email}<br>
                        UID: ${user.uid}<br>
                        Email Verified: ${user.emailVerified}
                    `);
                    
                    // Automatically check faculty doc
                    setTimeout(checkFacultyDoc, 500);
                } else {
                    currentUser = null;
                    log('‚ùå No user authenticated', 'error');
                    updateStepStatus('authStatus', 'error', `
                        <strong>‚ùå No User Authenticated</strong><br>
                        Please <a href="index.html">login</a> first.
                    `);
                }
            });
        }

        async function checkFacultyDoc() {
            if (!currentUser) {
                log('‚ùå Cannot check faculty document - no user authenticated', 'error');
                return;
            }

            try {
                log(`Checking faculty document for UID: ${currentUser.uid}`);
                const db = firebase.firestore();
                const facultyDoc = await db.collection('faculty').doc(currentUser.uid).get();
                
                if (facultyDoc.exists) {
                    const data = facultyDoc.data();
                    facultyProfile = data;
                    log('‚úÖ Faculty document exists', 'success');
                    log(`Faculty data: ${JSON.stringify(data, null, 2)}`);
                    
                    updateStepStatus('facultyDocStatus', 'success', `
                        <strong>‚úÖ Faculty Document Found</strong><br>
                        Name: ${data.fullName || 'Not set'}<br>
                        Employee ID: ${data.employeeId || 'Not set'}<br>
                        Subjects: ${data.subjects ? data.subjects.join(', ') : 'None'}<br>
                        Departments: ${data.departments ? data.departments.join(', ') : 'None'}
                    `);
                    
                    // Automatically test permissions
                    setTimeout(testPermissions, 500);
                } else {
                    log('‚ùå Faculty document does not exist!', 'error');
                    updateStepStatus('facultyDocStatus', 'error', `
                        <strong>‚ùå Faculty Document Missing</strong><br>
                        This is the cause of the permission error!<br>
                        The Firestore rules require a document in the 'faculty' collection<br>
                        for the current user to access batch reports.
                    `);
                    
                    // Show fix section
                    document.getElementById('fixSection').style.display = 'block';
                }
            } catch (error) {
                log(`‚ùå Error checking faculty document: ${error.message}`, 'error');
                updateStepStatus('facultyDocStatus', 'error', `
                    <strong>‚ùå Error Checking Faculty Document</strong><br>
                    ${error.message}
                `);
            }
        }

        async function testPermissions() {
            if (!currentUser) {
                log('‚ùå Cannot test permissions - no user authenticated', 'error');
                return;
            }

            try {
                const db = firebase.firestore();
                let allTestsPassed = true;
                let testResults = [];

                // Test 1: Users collection read
                try {
                    log('Testing users collection access...');
                    const usersTest = await db.collection('users').limit(1).get();
                    log(`‚úÖ Users collection: ${usersTest.docs.length} docs accessible`, 'success');
                    testResults.push('‚úÖ Users collection: PASS');
                } catch (error) {
                    log(`‚ùå Users collection: ${error.message}`, 'error');
                    testResults.push(`‚ùå Users collection: ${error.message}`);
                    allTestsPassed = false;
                }

                // Test 2: Attendances collection read
                try {
                    log('Testing attendances collection access...');
                    const attendanceTest = await db.collection('attendances').limit(1).get();
                    log(`‚úÖ Attendances collection: ${usersTest.docs.length} docs accessible`, 'success');
                    testResults.push('‚úÖ Attendances collection: PASS');
                } catch (error) {
                    log(`‚ùå Attendances collection: ${error.message}`, 'error');
                    testResults.push(`‚ùå Attendances collection: ${error.message}`);
                    allTestsPassed = false;
                }

                // Test 3: Profiles collection read
                try {
                    log('Testing profiles collection access...');
                    const profilesTest = await db.collection('profiles').limit(1).get();
                    log(`‚úÖ Profiles collection: ${profilesTest.docs.length} docs accessible`, 'success');
                    testResults.push('‚úÖ Profiles collection: PASS');
                } catch (error) {
                    log(`‚ùå Profiles collection: ${error.message}`, 'error');
                    testResults.push(`‚ùå Profiles collection: ${error.message}`);
                    allTestsPassed = false;
                }

                const status = allTestsPassed ? 'success' : 'error';
                const statusIcon = allTestsPassed ? '‚úÖ' : '‚ùå';
                
                updateStepStatus('permissionTest', status, `
                    <strong>${statusIcon} Permission Test Results</strong><br>
                    ${testResults.join('<br>')}
                `);

            } catch (error) {
                log(`‚ùå Error testing permissions: ${error.message}`, 'error');
                updateStepStatus('permissionTest', 'error', `
                    <strong>‚ùå Permission Test Failed</strong><br>
                    ${error.message}
                `);
            }
        }

        async function createFacultyDoc() {
            if (!currentUser) {
                log('‚ùå Cannot create faculty document - no user authenticated', 'error');
                return;
            }

            try {
                // Get user info
                const fullName = prompt('Enter your full name:', currentUser.displayName || '');
                if (!fullName) {
                    log('‚ùå Faculty creation cancelled - name required', 'warning');
                    return;
                }

                const employeeId = prompt('Enter your employee ID:', '');
                if (!employeeId) {
                    log('‚ùå Faculty creation cancelled - employee ID required', 'warning');
                    return;
                }

                log('Creating faculty document...');
                const db = firebase.firestore();
                
                const facultyData = {
                    fullName: fullName.trim(),
                    employeeId: employeeId.trim(),
                    email: currentUser.email,
                    role: 'faculty',
                    departments: ['General'], // Default department
                    subjects: ['JAVA', 'DSA', 'DBMS'], // Default subjects - user can update later
                    profileCompleted: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    phone: '' // Can be updated later
                };

                await db.collection('faculty').doc(currentUser.uid).set(facultyData);
                log('‚úÖ Faculty document created successfully!', 'success');

                // Also update users collection
                try {
                    await db.collection('users').doc(currentUser.uid).update({
                        fullName: fullName.trim(),
                        role: 'faculty',
                        profileCompleted: true,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    log('‚úÖ Users document updated successfully!', 'success');
                } catch (userUpdateError) {
                    log(`‚ö†Ô∏è Warning: Could not update users document: ${userUpdateError.message}`, 'warning');
                    log('This is not critical - the faculty document is sufficient for permissions', 'warning');
                }

                updateStepStatus('fixSection', 'success', `
                    <strong>‚úÖ Faculty Document Created!</strong><br>
                    Name: ${fullName}<br>
                    Employee ID: ${employeeId}<br>
                    Subjects: JAVA, DSA, DBMS (default - update in faculty dashboard)<br>
                    <br>
                    <strong>Next Steps:</strong><br>
                    1. <a href="faculty-dashboard.html">Go to Faculty Dashboard</a><br>
                    2. Complete your profile with correct subjects<br>
                    3. Try generating batch reports again
                `);

                // Re-test permissions
                setTimeout(testPermissions, 1000);

            } catch (error) {
                log(`‚ùå Error creating faculty document: ${error.message}`, 'error');
                updateStepStatus('fixSection', 'error', `
                    <strong>‚ùå Failed to Create Faculty Document</strong><br>
                    ${error.message}<br>
                    <br>
                    Make sure you have the correct permissions to write to Firestore.
                `);
            }
        }

        // Auto-start the diagnostic process
        document.addEventListener('DOMContentLoaded', () => {
            log('üîß Faculty Permissions Diagnostic Tool loaded');
            log('Starting authentication check...');
            setTimeout(checkAuth, 500);
        });
    </script>
</body>
</html>
